# iCalSched 软件架构图

## 1. 系统整体架构

### 1.1 分层架构图

```mermaid
graph TB
    subgraph "表现层 (Presentation Layer)"
        A1[MonthView 月视图]
        A2[WeekView 周视图]
        A3[DayView 日视图]
        A4[App.js 主应用]
        A5[Modal 组件]
        A6[UI 组件库]
    end
    
    subgraph "业务逻辑层 (Business Logic Layer)"
        B1[iCalendar 处理模块]
        B2[订阅管理模块]
        B3[通知管理模块]
        B4[农历计算模块]
        B5[主题管理模块]
        B6[事件管理模块]
    end
    
    subgraph "数据层 (Data Layer)"
        C1[AsyncStorage]
        C2[本地通知系统]
        C3[网络请求模块]
        C4[文件系统]
    end
    
    subgraph "平台层 (Platform Layer)"
        D1[iOS 平台]
        D2[Android 平台]
        D3[Web 平台]
    end
    
    A1 --> A4
    A2 --> A4
    A3 --> A4
    A4 --> A5
    A4 --> A6
    A4 --> B1
    A4 --> B2
    A4 --> B3
    A4 --> B4
    A4 --> B5
    A4 --> B6
    B1 --> C1
    B2 --> C1
    B2 --> C3
    B3 --> C2
    B4 --> C1
    B5 --> C1
    B6 --> C1
    C1 --> D1
    C1 --> D2
    C1 --> D3
    C2 --> D1
    C2 --> D2
    C3 --> D1
    C3 --> D2
    C3 --> D3
```

### 1.2 系统组件关系图

```mermaid
graph LR
    subgraph "用户界面"
        UI[用户界面]
    end
    
    subgraph "核心组件"
        APP[App.js 主应用]
        MV[MonthView 月视图]
        WV[WeekView 周视图]
        DV[DayView 日视图]
    end
    
    subgraph "工具模块"
        ICAL[iCalendar 模块]
        SUB[订阅管理模块]
        NOTIF[通知管理模块]
        LUNAR[农历计算模块]
        THEME[主题管理模块]
    end
    
    subgraph "数据存储"
        ASYNC[AsyncStorage]
        PUSH[推送通知系统]
        NET[网络请求]
    end
    
    UI --> APP
    APP --> MV
    APP --> WV
    APP --> DV
    APP --> ICAL
    APP --> SUB
    APP --> NOTIF
    APP --> LUNAR
    APP --> THEME
    ICAL --> ASYNC
    SUB --> ASYNC
    SUB --> NET
    NOTIF --> PUSH
    LUNAR --> ASYNC
    THEME --> ASYNC
```

## 2. 核心模块架构

### 2.1 主应用模块架构

```mermaid
graph TB
    subgraph "App.js 主应用"
        A[状态管理 State]
        B[事件处理 Handlers]
        C[模态框管理 Modals]
        D[视图切换 View Switching]
        E[通知集成 Notification Integration]
    end
    
    subgraph "状态管理"
        A1[events 事件列表]
        A2[subscriptions 订阅列表]
        A3[currentTheme 当前主题]
        A4[viewType 视图类型]
        A5[selectedDate 选中日期]
    end
    
    subgraph "事件处理"
        B1[handleSaveEvent 保存事件]
        B2[handleDeleteEvent 删除事件]
        B3[addSubscription 添加订阅]
        B4[removeSubscription 移除订阅]
        B5[handleThemeChange 切换主题]
    end
    
    subgraph "模态框管理"
        C1[事件编辑模态框]
        C2[订阅管理模态框]
        C3[主题选择模态框]
        C4[月份选择模态框]
    end
    
    subgraph "视图切换"
        D1[月视图 MonthView]
        D2[周视图 WeekView]
        D3[日视图 DayView]
    end
    
    subgraph "通知集成"
        E1[初始化通知]
        E2[调度通知]
        E3[取消通知]
        E4[测试通知]
    end
    
    A --> A1
    A --> A2
    A --> A3
    A --> A4
    A --> A5
    B --> B1
    B --> B2
    B --> B3
    B --> B4
    B --> B5
    C --> C1
    C --> C2
    C --> C3
    C --> C4
    D --> D1
    D --> D2
    D --> D3
    E --> E1
    E --> E2
    E --> E3
    E --> E4
```

### 2.2 iCalendar 模块架构

```mermaid
graph TB
    subgraph "iCalendar 模块"
        A[事件创建]
        B[事件解析]
        C[事件导出]
        D[重复规则]
        E[提醒管理]
    end
    
    subgraph "事件创建"
        A1[createVEvent]
        A2[updateVEvent]
        A3[deleteVEvent]
    end
    
    subgraph "事件解析"
        B1[parseICalendar]
        B2[parseICalDateTime]
        B3[parseRRule]
    end
    
    subgraph "事件导出"
        C1[exportToICalendar]
        C2[formatICalDate]
        C3[formatICalDateTime]
    end
    
    subgraph "重复规则"
        D1[buildRRule]
        D2[parseRRule]
        D3[getRRuleDescription]
    end
    
    subgraph "提醒管理"
        E1[createVAlarm]
        E2[getAlarmDescription]
        E3[parseTriggerToMinutes]
    end
    
    A --> A1
    A --> A2
    A --> A3
    B --> B1
    B --> B2
    B --> B3
    C --> C1
    C --> C2
    C --> C3
    D --> D1
    D --> D2
    D --> D3
    E --> E1
    E --> E2
    E --> E3
```

### 2.3 订阅管理模块架构

```mermaid
graph TB
    subgraph "订阅管理模块"
        A[订阅创建]
        B[订阅同步]
        C[订阅状态]
        D[预设订阅]
    end
    
    subgraph "订阅创建"
        A1[createSubscription]
        A2[validateSubscriptionUrl]
        A3[addSubscription]
    end
    
    subgraph "订阅同步"
        B1[syncSubscription]
        B2[fetchSubscription]
        B3[parseSubscription]
    end
    
    subgraph "订阅状态"
        C1[needsRefresh]
        C2[getSubscriptionStatus]
        C3[updateSubscriptionStatus]
    end
    
    subgraph "预设订阅"
        D1[中国法定节假日]
        D2[中国传统节日]
        D3[自定义订阅]
    end
    
    A --> A1
    A --> A2
    A --> A3
    B --> B1
    B --> B2
    B --> B3
    C --> C1
    C --> C2
    C --> C3
    D --> D1
    D --> D2
    D --> D3
```

### 2.4 通知管理模块架构

```mermaid
graph TB
    subgraph "通知管理模块"
        A[初始化]
        B[权限管理]
        C[通知调度]
        D[通知取消]
    end
    
    subgraph "初始化"
        A1[initializeNotifications]
        A2[配置通知渠道]
        A3[设置通知类型]
    end
    
    subgraph "权限管理"
        B1[requestNotificationPermissions]
        B2[checkNotificationPermissions]
        B3[handlePermissionResult]
    end
    
    subgraph "通知调度"
        C1[scheduleEventNotifications]
        C2[createNotification]
        C3[setNotificationTime]
    end
    
    subgraph "通知取消"
        D1[cancelEventNotifications]
        D2[cancelAllNotifications]
        D3[clearNotificationSchedule]
    end
    
    A --> A1
    A --> A2
    A --> A3
    B --> B1
    B --> B2
    B --> B3
    C --> C1
    C --> C2
    C --> C3
    D --> D1
    D --> D2
    D --> D3
```

## 3. 数据流架构

### 3.1 事件创建数据流

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as UI 组件
    participant APP as App.js
    participant ICAL as iCalendar 模块
    participant ASYNC as AsyncStorage
    participant NOTIF as 通知模块
    
    U->>UI: 点击添加事件
    UI->>UI: 打开事件编辑模态框
    U->>UI: 填写事件信息
    U->>UI: 点击保存
    UI->>APP: handleSaveEvent(eventData)
    APP->>ICAL: createVEvent(eventData)
    ICAL-->>APP: 返回事件对象
    APP->>APP: 更新 events 状态
    APP->>ASYNC: 保存事件到本地
    APP->>NOTIF: scheduleEventNotifications(event)
    NOTIF->>NOTIF: 调度本地通知
    NOTIF-->>APP: 返回调度结果
    APP->>UI: 关闭模态框
    UI-->>U: 显示成功提示
```

### 3.2 订阅同步数据流

```mermaid
sequenceDiagram
    participant U as 用户
    participant UI as UI 组件
    participant APP as App.js
    participant SUB as 订阅管理模块
    participant NET as 网络请求
    participant ICAL as iCalendar 模块
    participant ASYNC as AsyncStorage
    
    U->>UI: 点击同步订阅
    UI->>APP: syncSubscription(subscriptionId)
    APP->>SUB: syncSubscription(subscription)
    SUB->>NET: fetchSubscription(url)
    NET-->>SUB: 返回 iCalendar 内容
    SUB->>ICAL: parseICalendar(icsContent)
    ICAL-->>SUB: 返回事件列表
    SUB->>SUB: 合并事件数据
    SUB->>ASYNC: 保存订阅和事件
    ASYNC-->>SUB: 保存成功
    SUB-->>APP: 返回同步结果
    APP->>APP: 更新 subscriptions 状态
    APP->>UI: 更新 UI 显示
    UI-->>U: 显示同步完成提示
```

### 3.3 通知调度数据流

```mermaid
sequenceDiagram
    participant APP as App.js
    participant NOTIF as 通知模块
    participant PUSH as 推送通知系统
    participant OS as 操作系统
    
    APP->>NOTIF: scheduleEventNotifications(event)
    NOTIF->>NOTIF: 解析事件提醒设置
    NOTIF->>NOTIF: 计算通知时间
    NOTIF->>PUSH: scheduleNotification(notification)
    PUSH->>PUSH: 配置通知参数
    PUSH->>PUSH: 设置通知渠道
    PUSH->>OS: 注册通知
    OS-->>PUSH: 返回通知 ID
    PUSH-->>NOTIF: 返回调度结果
    NOTIF->>ASYNC: 保存通知 ID
    NOTIF-->>APP: 返回成功
```

## 4. 组件交互架构

### 4.1 视图切换流程

```mermaid
stateDiagram-v2
    [*] --> MonthView: 初始状态
    MonthView --> WeekView: 切换到周视图
    MonthView --> DayView: 切换到日视图
    WeekView --> MonthView: 切换到月视图
    WeekView --> DayView: 切换到日视图
    DayView --> MonthView: 切换到月视图
    DayView --> WeekView: 切换到周视图
    MonthView --> MonthView: 切换月份
    WeekView --> WeekView: 切换周
    DayView --> DayView: 切换日期
```

### 4.2 事件生命周期

```mermaid
stateDiagram-v2
    [*] --> 创建: 用户点击添加事件
    创建 --> 编辑: 打开编辑模态框
    编辑 --> 保存: 用户点击保存
    编辑 --> 取消: 用户点击取消
    保存 --> 已创建: 事件创建成功
    已创建 --> 编辑: 用户点击编辑
    已创建 --> 已删除: 用户点击删除
    编辑 --> 已更新: 事件更新成功
    已更新 --> 已删除: 用户点击删除
    已删除 --> [*]: 事件从列表中移除
    取消 --> [*]: 关闭模态框
```

### 4.3 订阅生命周期

```mermaid
stateDiagram-v2
    [*] --> 添加: 用户选择订阅
    添加 --> 同步中: 开始同步
    同步中 --> 已订阅: 同步成功
    同步中 --> 同步失败: 同步失败
    已订阅 --> 同步中: 手动同步
    已订阅 --> 已禁用: 用户禁用订阅
    已禁用 --> 已订阅: 用户启用订阅
    已订阅 --> 已删除: 用户删除订阅
    同步失败 --> 同步中: 重试同步
    同步失败 --> 已删除: 用户删除订阅
    已删除 --> [*]: 订阅从列表中移除
```

## 5. 技术架构

### 5.1 技术栈架构

```mermaid
graph TB
    subgraph "前端框架"
        A1[React Native 0.74.5]
        A2[Expo SDK 51]
    end
    
    subgraph "状态管理"
        B1[React Hooks]
        B2[useState]
        B3[useEffect]
    end
    
    subgraph "数据持久化"
        C1[AsyncStorage]
        C2[本地文件系统]
    end
    
    subgraph "通知系统"
        D1[react-native-push-notification]
        D2[@react-native-community/push-notification-ios]
    end
    
    subgraph "UI 组件"
        E1[React Native 核心]
        E2[lucide-react-native]
    end
    
    subgraph "构建工具"
        F1[Expo EAS Build]
        F2[Gradle]
        F3[Xcode]
    end
    
    subgraph "开发工具"
        G1[Babel]
        G2[ESLint]
        G3[VS Code]
    end
    
    A1 --> B1
    A2 --> B1
    B1 --> C1
    B1 --> D1
    A1 --> E1
    A1 --> E2
    A2 --> F1
    F1 --> F2
    F1 --> F3
    G1 --> A1
    G2 --> A1
```

### 5.2 平台适配架构

```mermaid
graph TB
    subgraph "跨平台层"
        A[React Native 代码]
    end
    
    subgraph "平台适配层"
        B1[Platform API]
        B2[条件渲染]
        B3[平台特定样式]
    end
    
    subgraph "iOS 平台"
        C1[iOS 原生模块]
        C2[iOS 通知系统]
        C3[iOS 文件系统]
    end
    
    subgraph "Android 平台"
        D1[Android 原生模块]
        D2[Android 通知系统]
        D3[Android 文件系统]
    end
    
    subgraph "Web 平台"
        E1[Web API]
        E2[浏览器存储]
        E3[Web 通知]
    end
    
    A --> B1
    A --> B2
    A --> B3
    B1 --> C1
    B1 --> D1
    B1 --> E1
    B2 --> C1
    B2 --> D1
    B2 --> E1
    B3 --> C1
    B3 --> D1
    B3 --> E1
```

## 6. 部署架构

### 6.1 构建流程架构

```mermaid
graph TB
    subgraph "开发环境"
        A1[源代码]
        A2[开发测试]
    end
    
    subgraph "构建过程"
        B1[代码检查]
        B2[编译打包]
        B3[签名配置]
    end
    
    subgraph "云端构建"
        C1[EAS Build]
        C2[Android 构建]
        C3[iOS 构建]
    end
    
    subgraph "分发渠道"
        D1[TestFlight]
        D2[Google Play]
        D3[App Store]
        D4[OTA 更新]
    end
    
    A1 --> B1
    A2 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> C1
    C1 --> C2
    C1 --> C3
    C2 --> D2
    C3 --> D1
    C3 --> D3
    C1 --> D4
```

### 6.2 运行时架构

```mermaid
graph TB
    subgraph "应用层"
        A1[React Native 应用]
        A2[JavaScript 运行时]
    end
    
    subgraph "桥接层"
        B1[Native Modules]
        B2[Native Components]
    end
    
    subgraph "原生层"
        C1[iOS 原生代码]
        C2[Android 原生代码]
    end
    
    subgraph "系统层"
        D1[iOS 系统]
        D2[Android 系统]
    end
    
    A1 --> A2
    A2 --> B1
    A2 --> B2
    B1 --> C1
    B1 --> C2
    B2 --> C1
    B2 --> C2
    C1 --> D1
    C2 --> D2
```

## 7. 数据存储架构

### 7.1 本地存储架构

```mermaid
graph TB
    subgraph "应用数据"
        A1[事件数据]
        A2[订阅数据]
        A3[主题数据]
        A4[用户设置]
    end
    
    subgraph "存储层"
        B1[AsyncStorage]
        B2[JSON 序列化]
    end
    
    subgraph "数据结构"
        C1[events 数组]
        C2[subscriptions 数组]
        C3[settings 对象]
    end
    
    subgraph "持久化"
        D1[iOS 文件系统]
        D2[Android 文件系统]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    A4 --> B1
    B1 --> B2
    B2 --> C1
    B2 --> C2
    B2 --> C3
    B1 --> D1
    B1 --> D2
```

### 7.2 数据同步架构

```mermaid
graph TB
    subgraph "本地数据"
        A1[本地事件]
        A2[本地订阅]
    end
    
    subgraph "同步逻辑"
        B1[数据比较]
        B2[冲突解决]
        B3[数据合并]
    end
    
    subgraph "远程数据"
        C1[订阅源]
        C2[iCalendar 文件]
    end
    
    subgraph "网络层"
        D1[HTTP 请求]
        D2[HTTPS 协议]
    end
    
    A1 --> B1
    A2 --> B1
    B1 --> B2
    B2 --> B3
    B3 --> A1
    B3 --> A2
    C1 --> D1
    C2 --> D1
    D1 --> D2
    D2 --> B1
```

## 8. 安全架构

### 8.1 数据安全架构

```mermaid
graph TB
    subgraph "数据输入"
        A1[用户输入]
        A2[网络数据]
    end
    
    subgraph "验证层"
        B1[输入验证]
        B2[URL 验证]
        B3[数据格式验证]
    end
    
    subgraph "加密层"
        C1[数据加密]
        C2[传输加密]
    end
    
    subgraph "存储层"
        D1[安全存储]
        D2[访问控制]
    end
    
    A1 --> B1
    A2 --> B2
    B1 --> B3
    B2 --> B3
    B3 --> C1
    B3 --> C2
    C1 --> D1
    C2 --> D1
    D1 --> D2
```

### 8.2 权限管理架构

```mermaid
graph TB
    subgraph "权限请求"
        A1[通知权限]
        A2[存储权限]
        A3[网络权限]
    end
    
    subgraph "权限检查"
        B1[权限状态检查]
        B2[权限结果处理]
    end
    
    subgraph "权限使用"
        C1[通知调度]
        C2[数据存储]
        C3[网络请求]
    end
    
    subgraph "系统权限"
        D1[iOS 权限系统]
        D2[Android 权限系统]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> C1
    B2 --> C2
    B2 --> C3
    C1 --> D1
    C1 --> D2
    C2 --> D1
    C2 --> D2
    C3 --> D1
    C3 --> D2
```

## 9. 性能优化架构

### 9.1 渲染优化架构

```mermaid
graph TB
    subgraph "组件层"
        A1[React.memo]
        A2[useMemo]
        A3[useCallback]
    end
    
    subgraph "列表优化"
        B1[FlatList]
        B2[虚拟化列表]
        B3[分页加载]
    end
    
    subgraph "动画优化"
        C1[Animated API]
        C2[原生驱动动画]
        C3[硬件加速]
    end
    
    subgraph "性能监控"
        D1[性能分析]
        D2[帧率监控]
        D3[内存监控]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> B3
    C1 --> C2
    C2 --> C3
    D1 --> A1
    D2 --> C1
    D3 --> B1
```

### 9.2 数据优化架构

```mermaid
graph TB
    subgraph "数据缓存"
        A1[内存缓存]
        A2[磁盘缓存]
        A3[订阅缓存]
    end
    
    subgraph "请求优化"
        B1[防抖]
        B2[节流]
        B3[请求合并]
    end
    
    subgraph "数据压缩"
        C1[Gzip 压缩]
        C2[数据精简]
        C3[增量更新]
    end
    
    subgraph "性能提升"
        D1[加载速度]
        D2[响应速度]
        D3[用户体验]
    end
    
    A1 --> B1
    A2 --> B2
    A3 --> B3
    B1 --> C1
    B2 --> C2
    B3 --> C3
    C1 --> D1
    C2 --> D2
    C3 --> D3
```

## 10. 扩展性架构

### 10.1 模块扩展架构

```mermaid
graph TB
    subgraph "核心模块"
        A1[事件管理]
        A2[订阅管理]
        A3[通知管理]
    end
    
    subgraph "扩展接口"
        B1[插件接口]
        B2[主题接口]
        B3[数据源接口]
    end
    
    subgraph "扩展模块"
        C1[自定义插件]
        C2[自定义主题]
        C3[自定义数据源]
    end
    
    subgraph "配置管理"
        D1[插件配置]
        D2[主题配置]
        D3[数据源配置]
    end
    
    A1 --> B1
    A2 --> B2
    A3 --> B3
    B1 --> C1
    B2 --> C2
    B3 --> C3
    C1 --> D1
    C2 --> D2
    C3 --> D3
```

### 10.2 平台扩展架构

```mermaid
graph TB
    subgraph "现有平台"
        A1[iOS 平台]
        A2[Android 平台]
        A3[Web 平台]
    end
    
    subgraph "平台适配"
        B1[平台检测]
        B2[平台特定代码]
        B3[平台样式]
    end
    
    subgraph "新平台"
        C1[Windows 平台]
        C2[macOS 平台]
        C3[Linux 平台]
    end
    
    subgraph "扩展支持"
        D1[原生模块]
        D2[平台 API]
        D3[构建配置]
    end
    
    A1 --> B1
    A2 --> B1
    A3 --> B1
    B1 --> B2
    B2 --> B3
    C1 --> D1
    C2 --> D1
    C3 --> D1
    D1 --> D2
    D2 --> D3
```

---

**文档版本**：1.0  
**最后更新**：2026-01-13  
**维护者**：iCalSched Team
