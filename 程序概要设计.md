# iCalSched 程序概要设计

## 1. 系统概述

### 1.1 系统目标
iCalSched 是一款基于 React Native 和 Expo 框架开发的跨平台智能日历应用，旨在为用户提供功能完整、设计精美的日历管理体验。系统支持多视图日历展示、农历显示、节假日标识、事件订阅、智能提醒等核心功能，采用 iOS 设计风格，确保在 iOS、Android 和 Web 平台上提供一致的用户体验。

### 1.2 系统特点
- **跨平台兼容**：基于 React Native，支持 iOS、Android 和 Web 平台
- **多视图支持**：月视图、周视图、日视图，满足不同场景需求
- **农历集成**：完整的农历日期显示和传统节日计算
- **事件订阅**：支持 iCalendar 格式的外部日历订阅
- **智能提醒**：基于本地推送通知的事件提醒系统
- **主题定制**：6 种预设主题，支持动态切换
- **数据持久化**：使用 AsyncStorage 本地存储事件和订阅数据

### 1.3 运行环境
- **开发环境**：Node.js 18+，Expo SDK 51
- **支持平台**：iOS 13+，Android 8.0+，现代 Web 浏览器
- **构建工具**：Expo EAS Build，Gradle (Android)，Xcode (iOS)

## 2. 系统架构

### 2.1 整体架构
系统采用分层架构设计，主要分为以下层次：

```
┌─────────────────────────────────────────────────────────┐
│                    表现层 (UI Layer)                     │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐              │
│  │ MonthView│  │ WeekView │  │ DayView  │              │
│  └──────────┘  └──────────┘  └──────────┘              │
│  ┌──────────────────────────────────────────────────┐  │
│  │           主应用组件 (App.js)                     │  │
│  │  - 状态管理  - 事件处理  - 模态框管理              │  │
│  └──────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                  业务逻辑层 (Business Layer)             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │  iCalendar   │  │   订阅管理    │  │   通知管理    │  │
│  │   处理模块    │  │   模块       │  │   模块       │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐                     │
│  │   农历计算    │  │   主题管理    │                     │
│  │   模块       │  │   模块       │                     │
│  └──────────────┘  └──────────────┘                     │
└─────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────┐
│                  数据层 (Data Layer)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ AsyncStorage │  │  本地通知    │  │  网络请求    │  │
│  │   持久化      │  │   系统       │  │   模块       │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 模块划分

#### 2.2.1 核心模块
- **主应用模块 (App.js)**：应用入口，负责状态管理、路由控制、事件处理
- **视图模块 (components/)**
  - MonthView.js：月视图组件，显示月份日历
  - WeekView.js：周视图组件，显示一周时间轴
  - DayView.js：日视图组件，显示单日事件列表

#### 2.2.2 工具模块 (utils/)
- **iCalendar 模块 (icalendar.js)**：处理 iCalendar 格式数据，包括事件的创建、解析、导出
- **订阅管理模块 (subscription.js)**：管理日历订阅，支持预设订阅和自定义订阅
- **通知管理模块 (notifications.js)**：处理本地推送通知，包括权限请求、通知调度
- **农历计算模块 (lunar.js)**：提供农历日期计算和传统节日识别
- **主题管理模块 (themes.js)**：管理应用主题，支持动态切换

### 2.3 数据流
```
用户操作 → UI 组件 → 事件处理器 → 业务逻辑层 → 数据层
                ↑                              ↓
                └──────── 状态更新 ←──────────┘
```

## 3. 模块设计

### 3.1 主应用模块 (App.js)

#### 3.1.1 功能描述
主应用模块是整个应用的核心，负责：
- 应用状态管理（事件、订阅、主题、视图类型等）
- 用户交互处理（创建、编辑、删除事件）
- 模态框管理（事件编辑、订阅管理、主题选择等）
- 视图切换（月视图、周视图、日视图）
- 通知集成

#### 3.1.2 主要状态
```javascript
// 事件相关
events: Array<Event>
editingEvent: Event | null
modalVisible: boolean

// 订阅相关
subscriptions: Array<Subscription>
subscriptionModalVisible: boolean
syncing: boolean

// 主题相关
currentTheme: string
themeModalVisible: boolean

// 视图相关
viewType: 'month' | 'week' | 'day'
currentMonth: Date
selectedDate: string
```

#### 3.1.3 主要函数
- `handleSaveEvent()`：保存事件（创建或更新）
- `handleDeleteEvent()`：删除事件
- `addSubscription()`：添加订阅
- `removeSubscription()`：移除订阅
- `syncSubscription()`：同步订阅
- `handleThemeChange()`：切换主题
- `handleViewTypeChange()`：切换视图类型

### 3.2 iCalendar 模块 (icalendar.js)

#### 3.2.1 功能描述
处理 iCalendar (RFC 5545) 格式数据，提供事件的创建、解析、导出功能。

#### 3.2.2 主要常量
```javascript
// 事件状态
EVENT_STATUS = {
  TENTATIVE: 'TENTATIVE',
  CONFIRMED: 'CONFIRMED',
  CANCELLED: 'CANCELLED'
}

// 优先级
PRIORITY = {
  HIGH: 1,
  MEDIUM: 5,
  LOW: 9
}

// 重复频率
FREQ = {
  DAILY: 'DAILY',
  WEEKLY: 'WEEKLY',
  MONTHLY: 'MONTHLY',
  YEARLY: 'YEARLY'
}

// 提醒触发时间
ALARM_TRIGGER = {
  MINUTES_0: 0,
  MINUTES_5: 5,
  MINUTES_15: 15,
  MINUTES_30: 30,
  MINUTES_60: 60,
  HOURS_24: 1440,
  DAYS_1: 1440
}

// 提醒动作
ALARM_ACTION = {
  DISPLAY: 'DISPLAY',
  AUDIO: 'AUDIO'
}
```

#### 3.2.3 主要函数
- `createVEvent(eventData)`：创建 iCalendar 事件对象
- `updateVEvent(event, updates)`：更新事件数据
- `formatICalDate(date)`：格式化日期为 iCalendar 格式
- `formatICalDateTimeFromString(dateStr, timeStr)`：格式化日期时间
- `parseICalDateTime(dateTimeStr)`：解析 iCalendar 日期时间
- `exportToICalendar(events)`：导出事件为 iCalendar 格式
- `parseICalendar(icsContent)`：解析 iCalendar 内容
- `buildRRule(freq, interval, count, weekdays)`：构建重复规则
- `parseRRule(rruleStr)`：解析重复规则
- `createVAlarm(trigger, action)`：创建提醒对象
- `getAlarmDescription(trigger)`：获取提醒描述

### 3.3 订阅管理模块 (subscription.js)

#### 3.3.1 功能描述
管理外部日历订阅，支持预设订阅和自定义订阅，提供订阅同步功能。

#### 3.3.2 主要常量
```javascript
// 预设日历
PRESET_CALENDARS = {
  CHINA_HOLIDAYS: {
    id: 'china-holidays',
    name: '中国法定节假日',
    description: '国务院发布的法定节假日安排',
    url: '...'
  },
  CHINA_LUNAR: {
    id: 'china-lunar',
    name: '中国传统节日',
    description: '春节、端午、中秋等传统节日',
    url: '...'
  }
}

// 订阅分类
SUBSCRIPTION_CATEGORIES = {
  HOLIDAYS: '节假日',
  LUNAR: '农历',
  CUSTOM: '自定义'
}
```

#### 3.3.3 主要函数
- `createSubscription(url, name, category)`：创建订阅
- `syncSubscription(subscription)`：同步订阅内容
- `needsRefresh(subscription)`：检查是否需要刷新
- `getSubscriptionStatus(subscription)`：获取订阅状态
- `validateSubscriptionUrl(url)`：验证订阅 URL

### 3.4 通知管理模块 (notifications.js)

#### 3.4.1 功能描述
处理本地推送通知，包括权限请求、通知调度、通知取消等功能。

#### 3.4.2 主要函数
- `initializeNotifications()`：初始化通知系统
- `requestNotificationPermissions()`：请求通知权限
- `scheduleEventNotifications(event)`：为事件安排通知
- `cancelEventNotifications(eventId)`：取消事件通知
- `testNotification()`：发送测试通知

#### 3.4.3 Android 配置
```javascript
const ANDROID_CHANNEL_ID = 'calendar-events';
const ANDROID_CHANNEL_NAME = '日历事件提醒';
const ANDROID_CHANNEL_DESCRIPTION = '用于日历事件提醒的通知渠道';
```

### 3.5 农历计算模块 (lunar.js)

#### 3.5.1 功能描述
提供农历日期计算和传统节日识别功能。

#### 3.5.2 主要函数
- `getLunarDate(solarDate)`：获取农历日期
- `getSolarDate(lunarYear, lunarMonth, lunarDay)`：获取公历日期
- `getTraditionalFestivals(year)`：获取传统节日列表
- `isHoliday(date)`：判断是否为节假日
- `getHolidayName(date)`：获取节假日名称

### 3.6 主题管理模块 (themes.js)

#### 3.6.1 功能描述
管理应用主题，支持动态切换主题。

#### 3.6.2 预设主题
```javascript
THEMES = {
  apple: 'Apple 风格',
  google: 'Google 风格',
  outlook: 'Outlook 风格',
  dark: '深色模式',
  light: '浅色模式',
  colorful: '多彩主题'
}
```

#### 3.6.3 主要函数
- `getTheme(themeName)`：获取主题配置
- `getThemeList()`：获取所有主题列表

## 4. 数据结构设计

### 4.1 事件数据结构
```javascript
{
  id: string,                    // 事件唯一标识
  title: string,                  // 事件标题
  description: string,             // 事件描述
  location: string,               // 事件地点
  startDate: string,              // 开始日期 (YYYY-MM-DD)
  startTime: string,              // 开始时间 (HH:mm)
  endDate: string,                // 结束日期 (YYYY-MM-DD)
  endTime: string,                // 结束时间 (HH:mm)
  isAllDay: boolean,              // 是否全天事件
  priority: number,               // 优先级 (1-9)
  status: string,                 // 状态 (TENTATIVE/CONFIRMED/CANCELLED)
  rrule: string,                  // 重复规则
  alarms: Array<{                 // 提醒设置
    trigger: number,             // 提前时间（分钟）
    action: string                // 动作 (DISPLAY/AUDIO)
  }>,
  createdAt: string,              // 创建时间
  updatedAt: string               // 更新时间
}
```

### 4.2 订阅数据结构
```javascript
{
  id: string,                     // 订阅唯一标识
  name: string,                   // 订阅名称
  url: string,                    // 订阅 URL
  category: string,               // 订阅分类
  enabled: boolean,               // 是否启用
  lastSyncTime: string,           // 上次同步时间
  lastSyncStatus: string,         // 上次同步状态 (success/error/pending)
  eventCount: number,             // 事件数量
  createdAt: string,              // 创建时间
  updatedAt: string               // 更新时间
}
```

### 4.3 主题数据结构
```javascript
{
  name: string,                   // 主题名称
  primaryColor: string,           // 主色调
  secondaryColor: string,         // 次要色调
  backgroundColor: string,        // 背景色
  textColor: string,              // 文字颜色
  cardBackgroundColor: string,    // 卡片背景色
  borderColor: string,            // 边框颜色
  shadowColor: string,            // 阴影颜色
  eventColors: {                  // 事件颜色
    high: string,                 // 高优先级
    medium: string,               // 中优先级
    low: string                   // 低优先级
  }
}
```

## 5. 接口设计

### 5.1 内部接口

#### 5.1.1 事件管理接口
```javascript
// 创建事件
createVEvent(eventData): Event

// 更新事件
updateVEvent(event, updates): Event

// 删除事件
deleteEvent(eventId): void

// 获取事件
getEvents(dateRange): Array<Event>
```

#### 5.1.2 订阅管理接口
```javascript
// 添加订阅
addSubscription(subscription): Subscription

// 移除订阅
removeSubscription(subscriptionId): void

// 同步订阅
syncSubscription(subscriptionId): Promise<void>

// 获取订阅列表
getSubscriptions(): Array<Subscription>
```

#### 5.1.3 通知接口
```javascript
// 请求权限
requestNotificationPermissions(): Promise<boolean>

// 调度通知
scheduleEventNotifications(event): Promise<void>

// 取消通知
cancelEventNotifications(eventId): Promise<void>
```

### 5.2 外部接口

#### 5.2.1 iCalendar 数据接口
```javascript
// 导出为 iCalendar 格式
exportToICalendar(events): string

// 解析 iCalendar 格式
parseICalendar(icsContent): Array<Event>
```

#### 5.2.2 网络请求接口
```javascript
// 获取订阅内容
fetchSubscription(url): Promise<string>
```

## 6. 技术选型

### 6.1 前端框架
- **React Native 0.74.5**：跨平台移动应用开发框架
- **Expo SDK 51**：React Native 开发工具链，提供丰富的原生功能

### 6.2 状态管理
- **React Hooks**：使用 useState、useEffect 等原生 Hooks 进行状态管理

### 6.3 数据持久化
- **AsyncStorage**：本地数据存储，用于保存事件和订阅数据

### 6.4 通知系统
- **react-native-push-notification**：本地推送通知库
- **@react-native-community/push-notification-ios**：iOS 通知支持

### 6.5 UI 组件
- **React Native 核心**：View、Text、TouchableOpacity、Modal 等
- **lucide-react-native**：图标库

### 6.6 构建工具
- **Expo EAS Build**：云端构建服务
- **Gradle**：Android 构建工具
- **Xcode**：iOS 构建工具

### 6.7 开发工具
- **Babel**：JavaScript 编译器
- **ESLint**：代码检查工具

## 7. 性能优化

### 7.1 渲染优化
- 使用 React.memo 避免不必要的组件重新渲染
- 使用 FlatList 替代 ScrollView 处理长列表
- 优化动画性能，使用 Animated API

### 7.2 数据优化
- 使用 AsyncStorage 缓存订阅数据
- 实现增量同步，减少网络请求
- 使用防抖和节流优化用户输入

### 7.3 内存优化
- 及时清理不再使用的事件数据
- 优化图片资源加载
- 使用懒加载减少初始加载时间

## 8. 安全设计

### 8.1 数据安全
- 本地数据加密存储（可选）
- 敏感信息不记录日志
- 定期清理过期数据

### 8.2 网络安全
- 使用 HTTPS 协议进行网络请求
- 验证订阅 URL 的合法性
- 防止 XSS 和 CSRF 攻击

### 8.3 权限管理
- 最小权限原则，只请求必要的权限
- 动态请求通知权限，提升用户体验
- 提供权限拒绝后的友好提示

## 9. 扩展性设计

### 9.1 模块化设计
- 各模块职责明确，耦合度低
- 提供清晰的接口定义
- 支持插件式扩展

### 9.2 配置化设计
- 主题配置化，支持自定义主题
- 预设订阅可配置
- 支持多语言扩展

### 9.3 平台适配
- 使用 Platform API 进行平台判断
- 针对不同平台提供优化方案
- 保持跨平台一致性

## 10. 测试策略

### 10.1 单元测试
- 对核心工具函数进行单元测试
- 测试边界条件和异常情况
- 确保代码覆盖率

### 10.2 集成测试
- 测试模块间的交互
- 测试数据流和状态管理
- 测试用户操作流程

### 10.3 端到端测试
- 测试完整的用户使用场景
- 测试跨平台兼容性
- 测试性能指标

## 11. 部署方案

### 11.1 开发环境
- 使用 Expo Go 进行快速开发测试
- 使用 Expo Dev Client 进行原生功能测试

### 11.2 测试环境
- 使用 EAS Build 构建测试版本
- 通过 TestFlight 或 Google Play 内部分发测试

### 11.3 生产环境
- 使用 EAS Build 构建生产版本
- 发布到 App Store 和 Google Play
- 使用 OTA 更新机制进行热更新

## 12. 维护方案

### 12.1 版本管理
- 遵循语义化版本规范
- 维护详细的 CHANGELOG
- 定期发布更新

### 12.2 问题跟踪
- 使用 GitHub Issues 跟踪问题
- 及时响应用户反馈
- 优先处理关键问题

### 12.3 文档维护
- 保持 README 和 API 文档更新
- 提供详细的使用说明
- 维护开发者文档

## 13. 未来规划

### 13.1 功能扩展
- 支持多人协作和共享日历
- 添加天气信息显示
- 集成地图和导航功能
- 支持语音输入和智能助手

### 13.2 性能优化
- 进一步优化渲染性能
- 减少应用包体积
- 提升启动速度

### 13.3 用户体验
- 添加更多主题和自定义选项
- 优化动画效果
- 提供更多快捷操作

---

**文档版本**：1.0  
**最后更新**：2026-01-13  
**维护者**：iCalSched Team
